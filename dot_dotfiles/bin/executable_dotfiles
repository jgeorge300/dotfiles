#!/bin/zsh

autoload colors; colors

source $HOME/.dotfiles/zsh/common.zsh

setopt null_glob

# Log output
function log {
    local msg=$1
    local color=${2:-$fg_bold[green]}
    echo "$color>>>$reset_color $fg_bold[white]$msg$reset_color"
}

# Log output
function logSub {
    log $1 $fg_bold[blue]
}

# Log error output
function err {
    log $1 $fg_bold[red]
}

# Log warning output
function warn {
    log $1 $fg_bold[yellow]
}

# Get a file owner
function owner {
    if [[ $OSTYPE == darwin* ]]; then
        return $(stat -f '%Su' $1)
    fi
    return $(stat -c '%U' $1)
}

# Create a directory
function makedir {
    if [[ ! -d $1 ]]; then
        mkdir -p $1
        logSub "Created $1/"
    fi
}

# Create a symlink
function link {
    if [[ ! -r $2 ]]; then
        ln -s $1 $2
        logSub "Linked $1 -> $2"
    fi
}

# Sed
function sedInPlace {
    if [[ $OSTYPE == darwin* ]]; then
        sed -i "" $@
    else
        sed -i"" $@
    fi
}

# Fix terminal config
function fixterm {
    local tmpfile=$(mktemp /tmp/dotfiles.XXXXXX)
    curl --silent -o $tmpfile https://raw.githubusercontent.com/wez/wezterm/master/termwiz/data/wezterm.terminfo
    tic -x -o $HOME/.terminfo $tmpfile &> /dev/null
    rm $tmpfile
    logSub "Installed wezterm terminfo"

    # Fix terminal definition so C-H works properly in neovim
    kbs=$(infocmp | grep -o 'kbs=[^,]\+')
    if [[ $kbs =~ "kbs=^[hH]" ]]; then
        infocmp $TERM | sed 's/kbs=^[hH]/kbs=\\177/' > /tmp/$TERM.ti
        tic /tmp/$TERM.ti
        rm /tmp/$TERM.ti
        logSub "Fixed backspace code in terminfo"
    fi
}

# Check if a command exists
function checkcmd {
    local cmd=$1
    local required=$2
    if (( ! $+commands[$cmd] )); then
        err "$cmd is missing"
        if [[ $required == "1" ]]; then
            exit 1
        fi
    fi
}

# Basic health check
function dotfiles-health {
    local os=$(uname)

    checkcmd brew
    checkcmd tmux

    if [[ $os == "Linux" ]]; then
        checkcmd unzip 1
        checkcmd xclip
    fi
}

# Rebuild bat cache
function dotfiles-bat {
    if (( ! $+commands[bat] )); then
      warn "Skipping bat cache update due to missing bat"
      return
    fi
    log "Rebuilding bat cache..."
    local out=$(bat cache --build 2>&1)
    if (( $? )); then
        err "Error rebuilding bat cache"
        err $out
    fi
}

# Install build tools necessary for building other things like python
function dotfiles-buildtools {
    log "Installing build tools..."
    local out=""
    local code=""

    if [[ $OSTYPE == linux* ]]; then
        local installed_packages=($(dpkg-query --show --showformat '${Package}\n'))
        local desired_packages=(
            make
            build-essential
            libssl-dev
            zlib1g-dev
            libbz2-dev
            libreadline-dev
            libsqlite3-dev
            wget
            curl
            llvm
            libncursesw5-dev
            xz-utils
            tk-dev
            libxml2-dev
            libxmlsec1-dev
            libffi-dev
            liblzma-dev
        )
        for pkg in $desired_packages; do
            if ((! $installed_packages[(Ie)$pkg])); then
                out=$(sudo apt install -y $pkg 2>&1)
                if (( $? )); then
                    err "Error installing $pkg"
                    err $out
                else
                    logSub "Installed $pkg"
                fi
            fi
        done
    else
        out=$(brew install openssl readline sqlite3 xz zlib 2>&1)
        if (( $? )); then
            err "Error installing build tools"
            err $out
        fi
    fi
}

# Install terminal fonts
function dotfiles-fonts {
    log "Installing terminal fonts..."

    if [[ $OSTYPE == darwin* ]]; then
        local fonts
        fonts=($HOME/Library/Fonts/Symbols-1000*(NY1))
        if (( ${#fonts} == 0 )) then
            curl --silent -o "$HOME/Library/Fonts/Symbols-1000-em Nerd Font Complete.ttf" "https://raw.githubusercontent.com/ryanoasis/nerd-fonts/master/src/glyphs/Symbols-1000-em%20Nerd%20Font%20Complete.ttf"
            logSub "Installed Symbols-1000-em Nerd Font Complete"
        fi
    fi
}

# Link dotfiles into $HOME, update terminfo
function dotfiles-home {
    log "Updating home directory files..."

    # Remove broken links
    for f in $HOME/.*(@) $XDG_CONFIG_HOME/*(@); do
        if [[ ! -e $f ]]; then
            rm $f
            logSub "Removed $f"
        fi
    done

    for f in $DOTFILES/home/*(.); do
        link $f $HOME/.$f:t
    done

    makedir $XDG_CONFIG_HOME

    for f in $DOTFILES/config/*; do
        if [[ -d $XDG_CONFIG_HOME/$f:t ]] && [[ ! -L $XDG_CONFIG_HOME/$f:t ]]; then
            mkdir -p $XDG_CONFIG_HOME/local
            mv $XDG_CONFIG_HOME/$f:t $XDG_CONFIG_HOME/local/$f:t
            logSub "Moved $XDG_CONFIG_HOME/$f:t -> $XDG_CONFIG_HOME/local/$f:t"
        fi
        link $f $XDG_CONFIG_HOME/$f:t
    done

    makedir $XDG_CACHE_HOME/tmux/resurrect
    makedir $XDG_CACHE_HOME/zsh
    makedir $XDG_CACHE_HOME/direnv/allow

    # Fix the terminal definition so that C-H works properly in neovim. This
    # function may also need to be run for the tmux terminal type.
    fixterm
}

# Install terminal fonts
function dotfiles-fonts {
    log "Installing terminal fonts..."
    local fonts

    if [[ $OSTYPE == darwin* ]]; then
        fonts=($HOME/Library/Fonts/Symbols-1000*(NY1))
        if (( ${#fonts} == 0 )) then
            curl --silent -o "$HOME/Library/Fonts/Symbols-1000-em Nerd Font Complete.ttf" 'https://raw.githubusercontent.com/ryanoasis/nerd-fonts/master/src/glyphs/Symbols-1000-em%20Nerd%20Font%20Complete.ttf'
            logSub "Installed Symbols font"
        fi
    fi
}

# Link and activate launchd scripts
function dotfiles-launchd {
    log "Linking and bootstrapping launchd scripts..."

    for f in $DOTFILES/launchd/*; do
        if [[ ! -h $HOME/Library/LaunchAgents/$f:t ]]; then
            link $f $HOME/Library/LaunchAgents/$f:t
            launchctl bootstrap gui/$UID $HOME/Library/LaunchAgents/$f:t
            logSub "Bootstrapped $f:t"
        fi
    done
}

# Install homebrew and core packages, update packages
function dotfiles-brew {
    if [[ $OSTYPE == linux* ]]; then
        local base_group=$(stat -c '%G' $HOMEBREW_BASE)
        if [[ $base_group != 'brew' ]]; then
            err "$HOMEBREW_BASE is not owned by brew group"
            return
        fi
    fi

    log "Updating brew..."

    if [[ $OSTYPE == linux* ]]; then
        if (( ! $+commands[git] )) || (( ! $+commands[gcc] )) || (( ! $+commands[curl] )); then
            logSub "Installing system requirements..."
            sudo apt-get update
            sudo apt-get install -y build-essential curl file git || true
        fi
    fi

    if ! hash brew; then
        log "Installing homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

        # If homebrew was just installed, ensure it's in the path
        export PATH=$HOMEBREW_BASE/bin:$PATH

        if [[ $OSTYPE == linux* ]]; then
            # Add a brew group so that the current user can manage brew
            sudo groupadd brew
            sudo usermod -a -G brew $USER
            sudo chgrp -R brew $HOMEBREW_BASE
            sudo chmod g+w -R $HOMEBREW_BASE
        fi

        rehash
    fi

    logSub "Checking for missing brew packages..."
    brew_packages=(
        'asdf'        # version manager
        'bash'        # update from system stock version
        'bat'         # better cat
        'direnv'      # environment manager
        'fd'          # file finder
        'fzf'         # fuzzy finder
        'git'         # update from system stock git
        'git-delta'   # prettier git diffs
        'jq'          # command line JSON processor
        'pdm'         # python package manager
        'python@3.9'  # default python
        'ripgrep'     # better grep
        'starship'    # prompt
        'stylua'      # lua formatter
        'tig'         # terminal git ui
        'tmux'        # terminal multiplexer
    )

    brew_casks=""

    if [[ $OSTYPE == darwin* ]]; then
        brew_casks=(
            'font-jetbrains-mono-nerd-font'
            'phoenix'
            '1password-cli'
        )

        taps=($(brew tap))
        if ((! $taps[(Ie)homebrew/cask-fonts])); then
            brew tap homebrew/cask-fonts
        fi
    fi

    local need_rehash=0

    local installed_packages=($(brew ls --versions $brew_packages | awk '{ print $1 }'))
    for pkg in $brew_packages; do
        if ((! $installed_packages[(Ie)$pkg])); then
            logSub "Installing $pkg..."
            brew install $pkg
            need_rehash=1
        fi
    done

    if [[ $OSTYPE == darwin* ]]; then
        local installed_casks=($(brew ls --versions --cask $brew_casks | awk '{ print $1 }'))
        for pkg in $brew_casks; do
            if ((! $installed_casks[(Ie)$pkg])); then
                logSub "Installing $pkg..."
                brew install $pkg
                need_rehash=1
            fi
        done
    fi

    if (( $need_rehash )); then
        # Let the shell know about any newly installed packages
        rehash
    fi

    logSub "Updating installed brew packages..."
    brew upgrade

    # Remove git's included zsh completions in favor of the system completions
    if [[ -f $HOMEBREW_BASE/share/zsh/site-functions/_git ]]; then
	hb_owner=$(owner $HOMEBREW_BASE)
	if [[ $hb_owner == $USER ]]; then
            rm -f $HOMEBREW_BASE/share/zsh/site-functions/_git
	else
            sudo rm -f $HOMEBREW_BASE/share/zsh/site-functions/_git
	fi
    fi

    # Update 1password-cli zsh completions
    if (( $+commands[op] )); then
        op completion zsh >! $ZDATADIR/functions/_op
    fi
}

# Install or update deno
function dotfiles-deno {
    log "Updating deno..."

    local out=""
    local version=""

    if (( ! $+commands[deno] )); then
        logSub "Installing..."
        out=$(curl -fsSL https://deno.land/x/install/install.sh | sh)
        if (( $? )); then
            err "Error installing deno"
            err $out
        fi
        rehash
    else
        out=$(deno upgrade)
        if [[ ! $out =~ "is the most recent release" ]]; then
            version=$(deno --version | grep 'deno [0-9]' | awk '{print $2}')
            logSub "Installed version $version"
        fi
    fi

    deno completions zsh >! $ZDATADIR/functions/_deno
}

# Install or update bun
function dotfiles-bun {
    log "Updating bun..."

    local out=""
    local version=""

    if (( ! $+commands[bun] )); then
        logSub "Installing..."
        out=$(curl https://bun.sh/install | bash)
        if (( $? )); then
            err "Error installing bun"
            err $out
        fi
        rehash
    else
        local message=$(bun upgrade 2>&1)
        if [[ $message == "Congrats *" ]]; then
            logSub "Upgraded bun to v$(bun -v)"
        fi
    fi

    bun completions > /dev/null

    # remove completion line added to zshrc
    local zshrc=$ZDOTDIR/.zshrc
    local line=$(grep -n '# bun completions' $ZDOTDIR/.zshrc | cut -f1 -d:)
    if [[ -n $line ]]; then
        local start
        (( start = $line - 1 ))
        local end
        (( end = $line + 1 ))
        sedInPlace "${start},${end}d" "$zshrc"
    fi

    # remove compinit call in bun completions
    if [[ -f "$HOME/.bun/_bun" ]]; then
        sedInPlace "/^autoload .* compinit/s/^/# /" "$HOME/.bun/_bun"
    fi
}

# Install or update rust
function dotfiles-rust {
    if (( ! $+commands[rustup] )); then
        log "Installing rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    else
        log "Updating rust..."
        rustup update
    fi
}

# Update zsh plugins
function dotfiles-zsh {
    log "Updating zsh plugins..."

    if [[ -z $ZPLUGDIR ]]; then
        err "ZPLUGDIR not defined"
        return
    fi

    local out=""
    local head=""

    for plugin in $ZPLUGDIR/*/*; do
        head=$(git -C $plugin rev-parse HEAD)
        out=$(git -C $plugin pull -q --recurse-submodules 2>&1)
        if (( $? )); then
            err "Error updating ${plugin}"
            err $out
            continue
        fi
        out=$(git -C $plugin submodule update --remote 2>& 1)
        if (( $? )); then
            err "Error updating ${plugin}"
            err $out
            continue
        fi
        if [[ $(git -C $plugin rev-parse HEAD) != $head ]]; then 
            logSub "Updated ${plugin:h:t}/${plugin:t}"
        fi
    done
}

# Update global python packages
function dotfiles-python {
    if (( ! $+commands[python] )); then
        warn "Skipping python update due to missing python"
	return
    fi

    log "Updating global python packages..."

    local out=""
    out=$(direnv exec / pip install -U pip setuptools pynvim neovim-remote > /dev/null 2>& 1)
    if (( $? )); then
        err "Error updating packages"
        err $out
    fi
}

# Update global npm packages
function dotfiles-node {
    if (( ! $+commands[npm] )); then
        warn "Skipping node update due to missing npm"
	return
    fi

    log "Updating global node packages..."

    # get list of outdated global packages
    local mods=($(direnv exec / npm --registry=https://registry.npmjs.org outdated -g --parseable))
    for mod in $mods; do
        # extract current and latest fields
        array=(${(@s/:/)mod})
        currentPkg=$array[3]
        latestPkg=$array[4]

        # extract current and latest versions, minus any prerelease tags
        currentVerParts=(${(@s/@/)currentPkg})
        currentVer=$currentVerParts[2]
        latestVerParts=(${(@s/@/)latestPkg})
        latestVer=$latestVerParts[2]

        if [[ $latestVer == 'linked' ]]; then
            logSub "Skipping $latestPkg"
            continue
        fi

        # read versions into arrays
        current=(${(@s/./)currentVer})
        latest=(${(@s/./)latestVer})

        # if latest is newer than current, install latest
        if (( latest[1] > current[1] )) || {
            (( latest[1] == current[1] )) &&
            (( latest[2] > current[2] )) || {
                (( latest[1] == current[1] )) &&
                (( latest[2] == current[2] )) &&
                (( latest[3] > current[3] ));
            };
        }; then
            direnv exec / npm install --registry=https://registry.npmjs.org --progress=false -g $latestPkg > /dev/null
            logSub "Installed $latestPkg"
        fi
    done

    local desired_packages=(
        eslint_d
        neovim
    )

    for pkg in $desired_packages; do
        direnv exec / npm ls -g --depth=0 $pkg > /dev/null 2>&1
        if (( $? )); then
            local out=""
            out=$(direnv exec / npm install -g $pkg > /dev/null 2>&1 )
            if (( $? )); then
                err "Error installing $pkg"
                err $out
            else
                logSub "Installed $pkg"
            fi
        fi
    done
}

# Update tmux plugins
function dotfiles-tmux {
    log "Updating tmux plugins..."
    local out=""

    if [[ -z $TMUX_PLUGIN_MANAGER_PATH ]]; then
        err "TMUX_PLUGIN_MANAGER_PATH not defined"
        return
    fi

    if [[ -d $TMUX_PLUGIN_MANAGER_PATH/tpm ]]; then
        out=$($TMUX_PLUGIN_MANAGER_PATH/tpm/bin/install_plugins 2>&1)
        if (( $? )); then
            err "Error installing plugins"
            err $out
        fi
    fi

    if [[ -d $TMUX_PLUGIN_MANAGER_PATH ]]; then
        for plugin in $TMUX_PLUGIN_MANAGER_PATH/*; do
            head=$(git -C $plugin rev-parse HEAD)
            git -C $plugin pull -q --recurse-submodules > /dev/null
            if (( $? )); then
                err "Error updating $plugin"
                continue
            fi
            git -C $plugin submodule update --remote -q
            if (( $? )); then
                err "Error updating $plugin"
                continue
            fi
            if [[ $(git -C $plugin rev-parse HEAD) != $head ]]; then 
                logSub "Updated ${plugin:t}"
            fi
        done
    fi
}

function get-asdf-version {
    local plugin=$1
    version=$(asdf current $plugin 2> /dev/null)
    if [[ -z $version ]]; then
        local versions=($(asdf list $plugin 2> /dev/null))
        if [[ -n $versions ]]; then
            version=$(echo $versions[-1] | awk '{ print $1 }')
        fi
    else
        version=$(echo $version | awk '{ print $2 }')
    fi
    echo $version
}

# Update asdf plugins
function dotfiles-asdf {
    if (( ! $+commands[asdf] )); then
        warn "Skipping asdf update due to missing asdf"
        return
    fi

    log "Updating asdf..."

    # All installed plugins
    local asdf_plugins=($(asdf plugin list))

    # Other plugins that should be installed
    local asdf_desired_plugins=(
        direnv
        python
        java
        ruby
        nodejs
    )

    local -a installed_plugins

    # Add any missing plugins
    for plugin in $asdf_desired_plugins; do
        if (( ! $asdf_plugins[(Ie)$plugin] )); then
            asdf plugin add $plugin > /dev/null
            installed_plugins+=($plugin)
            logSub "Installed $plugin plugin"
        fi
    done

    # Update all plugins
    for plugin in $(asdf plugin list); do
        if ((! $installed_plugins[(Ie)$plugin])); then
            local out=$(asdf plugin update $plugin)
            if [[ ! $out =~ 'Your branch is up to date' ]]; then
                logSub "Updated $plugin"
            fi
        fi
    done

    # Setup the "system" install for asdf-direnv
    if [[ ! -d $XDG_CONFIG_HOME/asdf-direnv ]]; then
        asdf direnv setup --shell zsh --version system
    fi
}

cd $HOME

if [[ -n $1 ]]; then
    if [[ $1 == -h || $1 == --help ]]; then
        echo 'usage: dotfiles [-h | --help | <group>]'
        echo
        echo 'Update local environment. All groups are updated by default.'
        echo
        echo 'Options:'
        echo '    -h, --help     Show this help message'
        echo '    <group>        A group to update'
        echo
        echo 'Available groups:'
        echo '    asdf           Update asdf plugins, install defaults'
        echo '    bat            Rebuild bat theme and filetype cache'
        echo '    brew           Update brew packages, install defaults'
        echo '    deno           Update deno'
        echo '    fonts          Install terminal fonts'
        echo '    rust           Update rust'
        echo '    home           Update dotfiles and home directories, fixup terminfo database'
        echo '    launchd        Link and bootstrap launchd scripts'
        echo '    node           Update global node packages, install defaults'
        echo '    python         Update global python packages, install defaults'
        echo '    tmux           Update tpm packages'
        echo '    vim            Update vim plugins'
        echo '    zsh            Update zsh plugins'
    elif [[ $1 == -* ]]; then
        echo "Unknown option $1"
        exit 1
    else
        dotfiles-$1
        log "Done"
    fi
else
    dotfiles-health
    dotfiles-home
    dotfiles-fonts
    dotfiles-brew
    dotfiles-fonts
    dotfiles-buildtools
    dotfiles-asdf
    dotfiles-deno
    dotfiles-bun
    dotfiles-rust

    dotfiles-zsh
    dotfiles-python
    dotfiles-node
    dotfiles-tmux
    dotfiles-bat

    if [[ $OSTYPE == darwin* ]]; then
        dotfiles-launchd
    fi

    log "Done"
fi
